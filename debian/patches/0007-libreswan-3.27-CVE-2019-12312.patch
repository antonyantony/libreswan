From: Paul Wouters <pwouters@redhat.com>
Date: Mon, 3 Jun 2019 19:24:08 -0400
Subject: libreswan 3.27 CVE-2019-12312

This is a cleaned up patch for
https://github.com/libreswan/libreswan/issues/246 as applied directly
against 3.27.

--
---
 programs/pluto/ikev2_send.c | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/programs/pluto/ikev2_send.c b/programs/pluto/ikev2_send.c
index d3b6f76..e222395 100644
--- a/programs/pluto/ikev2_send.c
+++ b/programs/pluto/ikev2_send.c
@@ -407,6 +407,17 @@ void send_v2_notification_from_state(struct state *pst, struct msg_digest *md,
 				     chunk_t *ndata)
 {
 	passert(md != NULL); /* always a reply */
+
+	/*
+	 * The caller must have computed DH and SKEYSEED; but may not
+	 * have authenticated (i.e., don't assume that the IKE SA has
+	 * "established").
+	 */
+	if (!pst->hidden_variables.st_skeyid_calculated) {
+		loglog(RC_LOG_SERIOUS, "Cannot send an encrypted response without SKEYSEED, dropping packet");
+		return;
+	}
+
 	const char *const notify_name = enum_short_name(&ikev2_notify_names, ntype);
 
 	enum isakmp_xchg_types exchange_type = md->hdr.isa_xchg;
